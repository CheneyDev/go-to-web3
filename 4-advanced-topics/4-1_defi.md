# 4.1: DeFi (去中心化金融)

DeFi (Decentralized Finance) 是构建在公链（主要是以太坊）上的金融应用的生态系统。它旨在利用区块链技术，创造一个无需依赖银行、券商等传统中心化金融机构的、开放、透明、可组合的金融世界。DeFi 是 Web3 领域最重要、最成熟的应用之一。

本章将介绍 DeFi 的两个核心基石：去中心化交易所 (DEX) 和借贷协议。

## 1. DEX (去中心化交易所)

DEX 允许用户在没有中心化中介的情况下，直接通过智能合约进行点对点的代币交易。与币安、Coinbase 等中心化交易所 (CEX) 不同，DEX 不会保管用户的私钥和资产，用户始终拥有对自己资产的完全控制权。

### AMM (自动做市商)

现代 DEX 的核心创新是 **自动做市商 (Automated Market Maker, AMM)** 模型。以 **Uniswap** 为代表的 AMM 协议，彻底改变了链上交易的方式。

传统订单簿模式的交易所在链上效率低下且 Gas 成本高昂。而 AMM 使用 **流动性池 (Liquidity Pools)** 来替代订单簿。

**核心思想:**

1.  **流动性池**: 每个交易对（例如 ETH/DAI）都有一个对应的智能合约，其中锁定了两种代币的资金池。
2.  **流动性提供者 (Liquidity Provider, LP)**: 任何用户都可以向资金池中按比例存入两种代币，成为 LP，并获得代表其份额的 LP 代币。他们提供流动性的动机是为了赚取该交易对产生的手续费。
3.  **交易者 (Trader)**: 当一个交易者想要用 ETH 换取 DAI 时，他将自己的 ETH 发送到资金池，资金池根据一个确定性的算法计算出他能获得多少 DAI，然后将 DAI 发送给他。这个过程完全由智能合约自动执行。

### Uniswap V2 的 `x * y = k` 模型

Uniswap V2 是最经典、最简洁的 AMM 实现。其核心算法是一个简单的常数乘积公式：

\[ x \cdot y = k \]

- **x**: 流动性池中代币 A 的数量。
- **y**: 流动性池中代币 B 的数量。
- **k**: 一个常数。

在任何交易发生之前和之后（忽略手续费），`k` 的值必须保持不变。这个公式决定了两种代币之间的汇率。

**示例:**
- 一个 ETH/DAI 池中有 10 个 ETH 和 2000 个 DAI。
- 此时 `k = 10 * 2000 = 20000`。
- 当前 ETH 的价格是 `y / x = 2000 / 10 = 200` DAI。
- 一个交易者想用 1 个 ETH 来兑换 DAI。他将 1 个 ETH 放入池中。
- 现在池中的 ETH 数量变为 `x' = 10 + 1 = 11`。
- 为了维持 `k` 不变，DAI 的数量必须变为 `y' = k / x' = 20000 / 11 ≈ 1818.18`。
- 交易者获得的 DAI 数量是 `y - y' = 2000 - 1818.18 = 181.82` DAI。
- 交易完成后，池中的状态是 11 个 ETH 和 1818.18 个 DAI，价格变为 `1818.18 / 11 ≈ 165.29`。

这个交易导致了 **价格滑点 (Price Slippage)**，池子里的资金量越大，单笔交易对价格的影响就越小，滑点也就越低。

### Uniswap V3 的集中流动性 (Concentrated Liquidity)

Uniswap V2 的模型虽然简单，但资本效率很低，因为流动性均匀地分布在从 0 到无穷大的整个价格曲线上。但对于稳定币交易对（如 USDC/DAI），价格几乎总是在 1.0 附近波动，分布在其他价格区间的流动性就完全被浪费了。

Uniswap V3 引入了 **集中流动性** 的概念，允许 LP 将他们的资金指定在一个特定的价格区间内提供。例如，一个 USDC/DAI 的 LP 可以选择只在 `[0.99, 1.01]` 这个区间内提供流动性。

**优势**:
- **资本效率**：在相同的资金量下，LP 可以在他们预期的价格范围内获得比 V2 高出数千倍的交易手续费。
- **更低的滑点**: 对交易者来说，因为流动性被集中在最活跃的交易区间，他们可以获得更好的交易价格（更低的滑点）。
- **无常损失 (Impermanent Loss)**: 这是 LP 面临的主要风险。简单来说，如果存入池中的代币价格发生剧烈波动，LP 取出流动性时，其资产的总价值可能会低于他当初直接持有这些代币的价值。集中流动性可能会加剧这种风险。

## 2. 借贷协议

DeFi 借贷协议（如 **Aave**, **Compound**）允许用户在无需许可的情况下借出或借入加密资产。

**核心机制:**

- **资金池模型**: 与 DEX 类似，借贷协议也采用资金池模型。用户将资产存入池中（例如，一个 ETH 池），成为存款人并开始赚取利息。其他用户则可以从这个池中借款。
- **利率模型**: 资产的借款利率和存款利率是根据池子的 **利用率 (Utilization Rate)** 动态调整的。
  - `利用率 = 总借款额 / 总存款额`
  - 如果利用率很低，说明资金供给过剩，协议会降低利率以鼓励借款。
  - 如果利用率很高，说明资金稀缺，协议会提高利率以鼓励存款和抑制借款。
- **超额抵押 (Over-collateralization)**: 这是 DeFi 借贷的基石。由于加密货币价格波动剧烈且没有传统金融中的信用评分，所有贷款都必须进行超额抵押。借款人必须存入价值高于其借款金额的资产作为抵押品。例如，存入价值 1000 美元的 ETH，可能最多只能借出价值 750 美元的 USDC。这个比率由抵押品的 **借贷价值比 (Loan-to-Value, LTV)** 决定。
- **清算 (Liquidation)**: 如果抵押品的市场价值因为价格下跌而低于某个阈值（清算阈值），这笔贷款就会被视为有风险。此时，协议允许任何人（清算人）来偿还一部分借款人的债务，并以折扣价购买相应的抵押品。这个机制保证了协议的偿付能力，确保存款人的资金安全。

DeFi 的世界是广阔且复杂的，但理解了 AMM 和超额抵押借贷这两个核心模型，你就掌握了解读绝大多数 DeFi 项目的关键。 